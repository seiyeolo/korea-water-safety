# Session Context - 2025-10-14

## 문제 분석

### 초기 보고
사용자가 교육 프로그램 페이지에서 "데이터를 불러올 수 없습니다 (Network Error)" 문제 보고

### 문제 진단 과정

1. **프론트엔드 코드 확인** ✅
   - [programs/page.tsx](../frontend/src/app/programs/page.tsx): API 연동 로직 정상
   - [usePrograms hook](../frontend/src/hooks/usePrograms.ts): getPrograms API 호출
   - [api.ts](../frontend/src/lib/api.ts): Railway API 엔드포인트 사용

2. **백엔드 API 테스트** ❌
   ```bash
   curl https://strong-wholeness-production.up.railway.app/api/programs
   # 결과: {"statusCode": 500, "message": "Internal server error"}
   ```

3. **로컬 백엔드 테스트** ✅
   - 로컬 실행: 정상 작동, 10개 프로그램 데이터 반환
   - [programs.service.ts](../backend/src/modules/programs/programs.service.ts): 로직 정상
   - [seed.ts](../backend/prisma/seed.ts): Seed 데이터 확인

4. **Railway 배포 로그 확인** 🔍
   - **에러**: `P1001: Can't reach database server at postgres.railway.internal:5432`
   - **원인**: 빌드 단계에서 데이터베이스 연결 시도

## 해결 과정

### 시도 1: Railway 설정 파일 추가 ❌
- `railway.json` 생성: 빌드 명령에 migrate/seed 포함
- `nixpacks.toml` 생성: 동일한 접근
- **문제**: Railway 빌드 단계에서는 DB 접근 불가

### 시도 2: Start 단계로 마이그레이션 이동 ❌
- 빌드: `npm run build` + `prisma generate`
- Start: `prisma migrate deploy && seed:prod && npm start`
- **문제**: 502 에러, 서버 시작 타임아웃

### 시도 3: Start 스크립트 분리 ✅ (최종 해결)
- [scripts/start.sh](../backend/scripts/start.sh) 생성
- 순차적 실행: migrate → seed (에러 허용) → server start
- `exec npm start`로 안정적인 프로세스 관리

## 적용된 변경사항

### 1. [backend/scripts/start.sh](../backend/scripts/start.sh) - NEW
```bash
#!/bin/bash
set -e

echo "🚀 Starting deployment process..."
npx prisma migrate deploy
npm run seed:prod || echo "⚠️ Seed skipped"
exec npm start
```

### 2. [backend/nixpacks.toml](../backend/nixpacks.toml) - MODIFIED
```toml
[phases.build]
cmds = ["npm run build", "npx prisma generate"]

[start]
cmd = "./scripts/start.sh"
```

### 3. [backend/railway.json](../backend/railway.json) - MODIFIED
```json
{
  "deploy": {
    "startCommand": "./scripts/start.sh"
  }
}
```

### 4. [backend/package.json](../backend/package.json) - MODIFIED
- `build`: `tsc && prisma generate`
- `postinstall`: `prisma generate`
- `seed:prod`: `node dist/prisma/seed.js`

### 5. [backend/prisma/seed.ts](../backend/prisma/seed.ts) - MODIFIED
- 중복 실행 방지: 데이터가 있으면 스킵
- 환경 구분 제거: 모든 환경에서 안전하게 실행

### 6. [backend/src/main.ts](../backend/src/main.ts) - MODIFIED
- CORS 설정 개선: 정규식 패턴 지원
- Vercel 와일드카드 도메인 지원

## Git 커밋 히스토리

```
afcd2c9 feat: Railway 시작 스크립트 개선
32d0f22 fix: Railway 빌드 프로세스 수정 - DB 연결 타이밍 해결
8053ec7 feat: Railway Nixpacks 설정 추가
7620816 fix: Railway 배포 시 자동 seed 실행 및 CORS 개선
```

## 다음 단계

1. ⏳ Railway 배포 완료 대기 (2-3분)
2. 🧪 API 엔드포인트 테스트
3. ✅ 프론트엔드에서 교육 프로그램 페이지 확인
4. 📝 세션 문서 업데이트

## 기술적 학습 포인트

### Railway 배포 제약사항
- **빌드 단계**: 데이터베이스 연결 불가
- **시작 단계**: 데이터베이스 접근 가능
- **해결책**: DB 작업을 start 스크립트로 이동

### Prisma 마이그레이션 전략
- **개발**: `prisma migrate dev`
- **프로덕션**: `prisma migrate deploy`
- **Seed**: 멱등성 확보 (중복 실행 안전)

### NestJS + Prisma + Railway 배포 패턴
```
빌드: TypeScript 컴파일 + Prisma Client 생성
시작: DB 마이그레이션 → Seed → 서버 실행
```

## 참고 링크
- Railway Docs: https://docs.railway.app
- Prisma Deploy: https://www.prisma.io/docs/guides/migrate/production
- NestJS Deployment: https://docs.nestjs.com/deployment
